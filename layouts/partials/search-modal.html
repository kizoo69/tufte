<div id="search-modal" aria-hidden="true" style="display: none;">
  <button id="search-close-btn" class="close-btn" aria-label="Close search">×</button>
  <div class="search-container" role="dialog" aria-modal="true" aria-label="Search">
    <div id="search"></div>
  </div>
</div>

<link href="/pagefind/pagefind-ui.css" rel="stylesheet">
<script src="/pagefind/pagefind-ui.js"></script>

<script>
window.addEventListener('DOMContentLoaded', (event) => {
    // Determine language from the html tag
    const currentLang = document.documentElement.lang || "en";

    // Initialize Pagefind
    if (typeof PagefindUI !== 'undefined') {
        new PagefindUI({
            element: "#search",
            showSubResults: true,
            // Filter by language. Pagefind automatically indexes the lang attribute.
            // If explicit filtering is needed:
            // filters: { lang: currentLang },
            // However, without knowing exact indexing behavior (regions vs base),
            // we will provide translations but rely on Pagefind's default relevance
            // or if the user specifically requested filtering, we can add it.
            // Given the requirement "Actual filter options specified", we add it.
            // We assume Pagefind indexes whatever is in <html lang="...">.
            filters: {
                lang: currentLang
            },
            translations: {
                placeholder: currentLang.startsWith('ko') ? "검색..." : "Search...",
                zero_results: currentLang.startsWith('ko') ? "[SEARCH_TERM]에 대한 결과가 없습니다" : "No results found for [SEARCH_TERM]"
            }
        });
    }

    const modal = document.getElementById('search-modal');
    const toggle = document.getElementById('search-toggle');
    const closeBtn = document.getElementById('search-close-btn');

    function openModal() {
        modal.style.display = 'flex';
        // Force reflow for transition
        void modal.offsetWidth;
        modal.classList.add('open');
        modal.setAttribute('aria-hidden', 'false');
        if (toggle) toggle.setAttribute('aria-expanded', 'true');

        // Focus input
        setTimeout(() => {
            const input = document.querySelector('.pagefind-ui__search-input');
            if (input) input.focus();
        }, 100);

        document.body.style.overflow = 'hidden'; // Prevent scrolling background
    }

    function closeModal() {
        modal.classList.remove('open');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 200); // Match transition
        modal.setAttribute('aria-hidden', 'true');
        if (toggle) toggle.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = '';
        if (toggle) toggle.focus(); // Return focus
    }

    if (toggle) {
        toggle.addEventListener('click', (e) => {
            e.stopPropagation();
            openModal();
        });
    }

    if (closeBtn) {
        closeBtn.addEventListener('click', closeModal);
    }

    // Close on click outside
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModal();
        }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('open')) {
            closeModal();
        }
        if (e.key === '/' && !modal.classList.contains('open') && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
            e.preventDefault(); // Prevent / from being typed if we focus input immediately
            openModal();
        }
    });
});
</script>
